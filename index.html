<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BURGER</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined&display=swap">
  <style>    
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #000;
      color: #fff;
      padding: 10px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    header h1 {
      margin-left: 4px; /* 移除預設的 margin */
      font-size: 1.5rem;
      text-transform: capitalize;
    }
    header div {
      margin-left: auto; /* 將按鈕推到右側 */
    }
    
    .copy-icon {
      display: inline-block; 
      font-size: 95%; 
      vertical-align: top; /* 垂直對齊到頂部 */
      margin-bottom: 4px;
      margin-left: 4px;
    }

    .copy-message{      
      font-weight: bold;
      display: none;
      font-size: 90%;
      margin-bottom: 4px;
      margin-left: 4px;
    }
    
    .walletbutton {
      margin-top: 2px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 2px solid #00d9ff;
      color: #00d9ff;
      background: transparent;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
    }
    .walletbutton:hover {
      background: #00d9ff;
      color: #000;
    }
    
    .claim_button {
        margin-top: 3px;              
        width: 55px; 
        height: 55px;
        border-radius: 50%;
        border: 2px solid #00d9ff;
        color: #00d9ff;
        background: transparent;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 50px; /* 與高度相同 */
    }
    .claim_button.active {
      background: #00d9ff;
      color: #000;
    }
    .re_button {
        display: none;
        margin-top: 3px;              
        width: 55px; 
        height: 55px;
        border-radius: 50%;
        border: 2px solid #ff4500;
        color: #ff4500;
        background: transparent;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        justify-content: center;
        align-items: center;
        line-height: 50px; /* 與高度相同 */
    }
    .re_button.active {
      background: #ff4500;
      color: #ff4500;
    }
    
    .notification {
      background-color: #1a1a1a;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification span {
       margin-left: 2px;       
    }
    
    .notification h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .notification p {
      margin: 0;
      color: #aaaaaa;
      font-size: 0.7rem;
    }
    
    .notification a {
      color: #1e90ff;
      text-decoration: none;
      font-weight: 600;
    }

    .css_back {
      color: #1e90ff;
      text-decoration: none;
      font-weight: 600;
    }
    
    .card {
      display: flex;
      flex-direction: column;
      background-color: #1a1a1a;
      padding: 6px 12px;
      border-radius: 8px;
      margin-bottom: 5px;
      }

    .card h2 {
       font-size: 1.25rem;
       font-weight: 600;
     }

     .reward-item {
       margin: 0;
       color: #bbbbbb;
       flex: 1;
     }     

      .buttons {
         display: flex;
         justify-content: space-between;
         margin-top: 16px;
       }

      .buttons button {
         flex: 1;
         text-align: center;
         margin: 0 4px;
         padding: 10px;
         border: none;
         border-radius: 8px;
         font-size: 0.9rem;
         line-height: 1.2;
         cursor: pointer;
         background-color: #4a4a4a;
         color: #fff;
         display: flex; /* 关键：将按钮设置为 flexbox 布局 */
         align-items: center; /* 垂直居中 */
         justify-content: center; /* 水平居中 */
       }

.buttons button.active {
  background-color: #fff;
  color: #000;
}

.progress-card {
  background-color: #1a1a1a;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 10px;
}

.progress-card p {
  font-size: 0.9rem;
  margin-bottom: 8px;
}
    
.progress {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.progress span{
   font-size: 0.9rem;
   margin-bottom: 8px;
}

.progress .steps {
   display: flex;
   gap: 8px;
}

    .steps span {
      width: 16px;
      height: 16px;
      background-color: #ff4500;
      border-radius: 50%;
    }
    footer {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #333;
    }

    footer a {
      color: #fff;
      font-size: 0.9rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      text-align: center;
      gap: 4px;
    }
    .material-symbols-outlined {
      font-variation-settings:
     'FILL' 0,
     'wght' 400,
     'GRAD' -25,
     'opsz' 40
    }
    .symbol-match {
      display: inline-block; 
      vertical-align: middle; 
      margin-bottom: 12px;
    }
    
    .new-container {
      //all: unset; /* 清除上層可能的樣式 */
      display: flex; 
      justify-content: flex-end; /* 或使用 margin-left: auto; */
    }

    .image-container {
       width: 200px;
       height: 200px;
       border-radius: 8px; /* 修圓角，50% 代表圓形 */
       box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3); /* 陰影效果 */
       overflow: hidden;  /* 隱藏超出部分 */ 
       margin-left: auto;
     }

     .image-container img {
        max-width: 250px;
        max-height: 250px;
        object-fit: cover; /* 保持圖片比例，填滿容器 */
      }

      .text-container {
       flex: 1; /* 讓文字部分佔用剩餘空間 */
      }

      .main-title {
       font-size: 24px; /* 調整主標題字體大小 */
       font-weight: bold;
    }
  
  </style>
</head>
<body>
  <header>
    <span class="material-symbols-outlined" id="hamburger">lunch_dining</span>
    <h1>BURGER</h1>
    <span class="material-symbols-outlined copy-icon" onclick="copyAddress()">content_copy</span>
    <span id="copyMessage" class="copy-message">copied</span>
    <div>
      <button class="walletbutton" id="walletButton" onclick="connectWallet()">Login</button>  
    </div>
  </header>  
  <script>
        function copyAddress() {
            // 获取合约地址文本
            const contractAddress = "0xFD8D045A381690a943d2B48cEE1dD81eea23343C";             
            navigator.clipboard.writeText(contractAddress)
                .then(() => {                   
                    const message = document.getElementById("copyMessage");
                    message.style.display = "block";
                    setTimeout(() => {
                        message.style.display = "none";
                    }, 2000);
                })
                .catch((err) => {
                    console.error("copy failed:", err);
                });
        }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
  <!-- 引入 Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <script>      
           // 取得推薦碼    
           function getParameterByName(name, url) {
               if (!url) url = window.location.href;
               name = name.replace(/[\[\]]/g, '\\$&');
               var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
               results = regex.exec(url);
               if (!results) return null;
               if (!results[2]) return '';
               return decodeURIComponent(results[2].replace(/\+/g, ' '));
           }          
           async function connectWallet() {
               var holder;
               if (typeof window.ethereum !== 'undefined') {  
                   try {
                        // Connect Wallet
                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }); 
                        holder = accounts[0].toLowerCase();
                        updateAccountUI(holder);       
                    } catch (error) {
                        console.log('No accounts available');
                    }
                } else {
                      // 如果瀏覽器中未檢測到電子錢包
                      alert('Login failed！Please try again via MetaMask.');
                }
                return holder;
          }   
    // 監聽帳號變化
    ethereum.on('accountsChanged', (accounts) => {    
      if (accounts.length > 0) {
         location.reload();
         //console.log('Account changed:', accounts[0]);
         //ready_togo(accounts[0]);
      } else {
        console.log('No accounts available');
      }
    });
    // 更新頁面上的帳號顯示
    function updateAccountUI(account) {
      const walletButton = document.getElementById('walletButton');
      walletButton.textContent = `${account.substring(0, 2)}...${account.slice(-4)}`;
    }    
  </script>  
  <div class="notification">
    <span class="material-symbols-outlined">brand_awareness</span>
    <span>The BURGER white paper has been released, please check for details..</span>
    <a href="#">Details</a>
  </div>
  <div id="card" class="card">
    <div class="progress" id="content">
      <div>
          <h2 id="notice_ad" style="display: none;"></h2>
          <h2 id="notice_title">AirDrop</h2>   
          <p class="reward-item" id="linetext_1">Holder reward: 3%</p>
          <p class="reward-item" id="linetext_2">Referal reward: 1%</p>
      </div>
      <div class="claim_button" id="claim_button">Get</div>
      <div class="re_button" id="re_button">Get</div>
    </div>
    <div class="buttons">
      <button class="buttons button.active" id="airdrop_btn">Get Airdrop</button>
      <button class="buttons button" id="activities_btn">Activities</button>
    </div>
  </div>
  <script>
        // Fetch and Replace Content
        document.getElementById("re_button").addEventListener("click", async (e) => {
            e.preventDefault(); // Prevent link navigation
            // Fetch the HTML content for red envelopes
            try {
                const script = document.createElement("script");
                script.src = "burger_gift.js"; 
                // Your JavaScript logic for dynamic interaction
                document.body.appendChild(script);
                //alert("script:"+ script );
            } catch (err) {
                console.error("Error loading content:", err);
                alert("Failed to load the red envelope page.");
            }
        });
    </script>
<script>
  //隨著不同的Button 切換不同的信息
  const claim_button = document.getElementById('claim_button');
  const re_button = document.getElementById('re_button');
  const getAirdropButton = document.getElementById('airdrop_btn');
  const activitiesButton = document.getElementById('activities_btn');
  const titleElement = document.getElementById('notice_title');
  const holderRewardElement = document.getElementById('linetext_1');
  const referalRewardElement = document.getElementById('linetext_2');

  getAirdropButton.classList.add('active'); 

  function swapButtonStyles() {
    getAirdropButton.classList.toggle('active');
    activitiesButton.classList.toggle('active');
  }

  function updateContent(isAirdrop) {
    titleElement.textContent = isAirdrop ? 'AirDrop' : 'Activities';
    holderRewardElement.textContent = isAirdrop ? 'Holder reward: 3%' : 'My Activities:';
    referalRewardElement.textContent = isAirdrop ? 'Referal reward: 1%' : 'Total Activities:';
  }

getAirdropButton.addEventListener('click', () => {
  swapButtonStyles();
  updateContent(true);
  claim_button.style.display = 'flex';  
  re_button.style.display = 'none';
});

activitiesButton.addEventListener('click', () => {
       swapButtonStyles();
       updateContent(false);
       claim_button.style.display = 'none';
       re_button.style.display = 'flex';
     });
  </script>

  <div class="progress-card">  
    <div class="progress">
      <div>
       <span id="link_icon" class="material-symbols-outlined">link</span>
       <span class="symbol-match" id="linkcodeDisplay"></span>
      </div>
      <div>
       <span class="material-symbols-outlined">heart_check</span>
       <span class="symbol-match" id="fans_count"></span>
      </div>
      <div>
       <span class="material-symbols-outlined">featured_seasonal_and_gifts</span>
       <span class="symbol-match" id="re_count"></span>
      </div>
    </div>
    <div class="progress">
      <span> Bitcoin/USD：</span>
      <span id="bitcoin-price"></span>
      <div class="steps">
        <span></span>
        <span></span>
        <span style="background-color: #4a4a4a;"></span>
      </div>
    </div>
  </div>

  <div class="notification">
    <div>
      <span>Balance of BURGER：</span>
      <p>Just updated</p>
    </div>
    <div>
      <h2 id="balance" >waiting..</h2>
    </div>
  </div>  
  <footer>
  <a href="#">
    <span class="material-symbols-outlined">home</span>
    Home
  </a>
  <a href="#">
    <span class="material-symbols-outlined" id="activities">search</span>
    活動
  </a>
  <a href="#">
    <span class="material-symbols-outlined">share</span>
    Share
  </a>
  </footer>
  <script>
    // 取得 linkcode 參數    
    var linkcode = getParameterByName('linkcode');
    //alert("to get linkcode:" + linkcode);
    function getlinkcode() {  
      try{
          if (linkcode != null){
             // alert(`Welcome！`+ linkcode);
             // 假設 linkcode 變數已經定義且包含要顯示的連結
             const linkcodeDisplay = document.getElementById('linkcodeDisplay');
             // 如果 linkcode 有值，則將其內容設置為顯示物件的內文
             linkcodeDisplay.textContent = linkcode;
         } else {
              // 如果 linkcode 沒有值，則顯示空白
             linkcodeDisplay.textContent = " ";
         }
      }catch(err){
        alert("error:"+err);
      }        
    }
  </script>
  <script>
        let clickHandler;
        let clickHandler_hb;
        //
        function disable_get_btn(holder){  
                const claim_btn = document.getElementById('claim_button');
                //alert("clickHandler：" + clickHandler);
                //change color
                claim_btn.classList.remove('active');   
                // disable click
                claim_btn.removeEventListener('click', clickHandler);
        }
        async function start_airdrop(holder) {
            // 確認彈窗
            
            if (confirm("確定要開啟新一輪的空投嗎？")) {
            // 點擊確認，開始執行    
            // 呼叫智能合約的 startAirdrop 函數
            try{
                 const tx = await contract.methods.startAirdrop().send({ from: holder });
                 // 顯示交易結果
                 console.log("Transaction hash:", tx.transactionHash);
                 alert("Airdrop started successfully!");
              } catch (error) {
                   console.error("Error starting airdrop:", error);
                   alert("Error starting airdrop. Please try again later.");
              } 
          } else {
                  // 如果使用者點擊取消，則什麼都不做
                  console.log("使用者取消啟動空投");
          }
    }
    
    async function claim_airdrop(holder) {      
        if ( confirm("請注意！領取空投必須付出Gas，您確定繼續？")) {      
        try {
              // 呼叫智能合約的 claimAirdrop 函數
              const result = await contract.methods.claimAirdrop().send({ from: holder });
              disable_get_btn();
              // 處理回傳值 (result)
              switch (result) {
                case 1:
                     alert("Airdrop not enabled");
                break;
                case 2:
                     alert("Airdrop expired");
                break;
                case 3:
                     alert("You have already claimed this airdrop");
                break;
                case 4:
                    alert("恭喜！成功領取空投！");
                  // 更新 UI 顯示 (例如：更新餘額、顯示領取成功訊息)
                 getBalance(holder); 
                break;
                default:
                      alert("Unknown error occurred during claim."+ result);
               break;
               }
              } catch (error) {
                   console.error("Error claiming airdrop:", error);
                   alert("Claiming airdrop failure.Try again later." + error);
               }
           }
        } 
let intervalId; 
function countdown(seconds) {  
  // 清除之前的計時器
  clearInterval(intervalId);
  const airdrop_btn = document.getElementById("airdrop_btn");
  let count = seconds;
  
  intervalId = setInterval(() => {
    airdrop_btn.textContent = count.toLocaleString()+" secs";
    count--;

    if (count < 0) {
      clearInterval(intervalId);
      airdrop_btn.textContent = "Get AirDrop";
      // 倒數結束後的處理
    }
  }, 1000);
}        
    
  //</script><script>
    // get balance of burger
    let web3;
    let contract;
    // 合約地址和 ABI
    const contractAddress = "0xFD8D045A381690a943d2B48cEE1dD81eea23343C"; // 替換為你的智能合約地址
    const contractABI =   [
      {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"holder","type":"address"},{"indexed":true,"internalType":"address","name":"receiver","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"ADClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"adCount","type":"uint256"}],"name":"ADStarted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"claimer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"}],"name":"reClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":true,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"uint256","name":"subAmt","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"maxClaims","type":"uint256"}],"name":"reCreated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"holder","type":"address"},{"indexed":true,"internalType":"address","name":"referer","type":"address"}],"name":"refSet","type":"event"},{"inputs":[],"name":"MinREshare","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MinSharePerRE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"_owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"adCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"adDuration","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"adEnabled","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"adStartTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimAirdrop","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"linkcode","type":"string"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"claimRE","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"cost_Edit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"_type","type":"uint8"},{"internalType":"string","name":"data","type":"string"}],"name":"editMyProfile","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAirDropInfo","outputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"linkcode","type":"string"}],"name":"getAvailableRE","outputs":[{"components":[{"internalType":"uint256","name":"subAmt","type":"uint256"},{"internalType":"uint256","name":"claimedAmt","type":"uint256"},{"internalType":"uint256","name":"maxClaims","type":"uint256"},{"internalType":"uint256","name":"claimCount","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint8","name":"eligiType","type":"uint8"},{"internalType":"string","name":"desc","type":"string"},{"internalType":"string","name":"imgUrl","type":"string"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct BurgerToken.reInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyFansCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyRE","outputs":[{"components":[{"internalType":"uint256","name":"subAmt","type":"uint256"},{"internalType":"uint256","name":"claimedAmt","type":"uint256"},{"internalType":"uint256","name":"maxClaims","type":"uint256"},{"internalType":"uint256","name":"claimCount","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint8","name":"eligiType","type":"uint8"},{"internalType":"string","name":"desc","type":"string"},{"internalType":"string","name":"imgUrl","type":"string"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct BurgerToken.reInfo[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyRefCode","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMyfansAddr","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getReCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bool","name":"isref","type":"bool"}],"name":"getReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_holder","type":"address"}],"name":"getSpecificHolder","outputs":[{"components":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"holderReward","type":"uint256"},{"internalType":"uint256","name":"referReward","type":"uint256"},{"internalType":"string","name":"refCode","type":"string"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"string","name":"imgUrl","type":"string"},{"internalType":"uint256","name":"lastClaimedAD","type":"uint256"},{"internalType":"bool","name":"isDistoStartRE","type":"bool"},{"internalType":"bool","name":"isDistoRef","type":"bool"}],"internalType":"struct BurgerToken.Holder","name":"holder","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"reid","type":"uint256"}],"name":"getSpecificRE","outputs":[{"components":[{"internalType":"uint256","name":"subAmt","type":"uint256"},{"internalType":"uint256","name":"claimedAmt","type":"uint256"},{"internalType":"uint256","name":"maxClaims","type":"uint256"},{"internalType":"uint256","name":"claimCount","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint8","name":"eligiType","type":"uint8"},{"internalType":"string","name":"desc","type":"string"},{"internalType":"string","name":"imgUrl","type":"string"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct BurgerToken.reInfo","name":"re","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"holderPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"holders","outputs":[{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"holderReward","type":"uint256"},{"internalType":"uint256","name":"referReward","type":"uint256"},{"internalType":"string","name":"refCode","type":"string"},{"internalType":"string","name":"nickname","type":"string"},{"internalType":"string","name":"description","type":"string"},{"internalType":"string","name":"imgUrl","type":"string"},{"internalType":"uint256","name":"lastClaimedAD","type":"uint256"},{"internalType":"bool","name":"isDistoStartRE","type":"bool"},{"internalType":"bool","name":"isDistoRef","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"refCode","type":"string"}],"name":"isValidRefCode","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"minRefAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"myRE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"myfans","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ownerPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"reID","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"redEnv","outputs":[{"internalType":"uint256","name":"subAmt","type":"uint256"},{"internalType":"uint256","name":"claimedAmt","type":"uint256"},{"internalType":"uint256","name":"maxClaims","type":"uint256"},{"internalType":"uint256","name":"claimCount","type":"uint256"},{"internalType":"address","name":"creator","type":"address"},{"internalType":"uint8","name":"eligiType","type":"uint8"},{"internalType":"string","name":"desc","type":"string"},{"internalType":"string","name":"imgUrl","type":"string"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"refCodeOwners","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"refPercent","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"bool","name":"_disabled","type":"bool"},{"internalType":"bool","name":"isRef","type":"bool"}],"name":"setDisabled","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refCode","type":"string"}],"name":"setMyRefCode","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_type","type":"uint8"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setParameter","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"totalShare","type":"uint256"},{"internalType":"uint256","name":"countRE","type":"uint256"},{"internalType":"uint8","name":"eligiType","type":"uint8"},{"internalType":"string","name":"_desc","type":"string"},{"internalType":"string","name":"_url","type":"string"}],"name":"setRE","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"refCode","type":"string"}],"name":"setReferrer","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_type","type":"uint256"},{"internalType":"uint8","name":"_percentage","type":"uint8"}],"name":"setRewardPercentage","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startAirdrop","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"toLower","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"bool","name":"isdesc","type":"bool"},{"internalType":"string","name":"data","type":"string"}],"name":"updateMyRE","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}
    ];        
    
    // 加載 Web3
    async function initialize() {  
          //alert("What;s up?!" + holder);
          //var holder;
          if (typeof window.ethereum !== "undefined") {
              try {
                    // 請求錢包授權
                    //await window.ethereum.request({ method: "eth_requestAccounts" });
                    //const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' }); 
                    const holder = await connectWallet();
                    //updateAccountUI(holder);
                    // 使用 MetaMask 提供的 provider 初始化 Web3
                    web3 = new Web3(window.ethereum);
                    // 初始化智能合約
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    console.log("Web3 和合約初始化完成！");
                    //alert("Holder:"+holder);
                    ready_togo(holder);
                } catch (error) {
                    alert("initiate Web3 failed：" + error);
                    console.error("initiate Web3 failed", error);
                }
          } else {
                    alert("請安裝MetaMask！");
          }        
    }
    function ready_togo(holder){
      // 按鈕綁定事件
        const activities_btn=document.getElementById("activities");
        const click_activities = () => setRedEnvelope(holder);
        activities_btn.addEventListener("click", click_activities);
      //
        getlinkcode();
        getBalance(holder);
        startup(holder);   
    }

        // 查詢餘額
        async function getBalance(holder) {
            if (!web3) {
                alert("Web3加載失敗，請重試！");
                return;
            }else if(!contract){
                alert("合約未初始化，請重試！");
                return;
            }
            if (!web3.utils.isAddress(holder)) {
                //alert("請用 Metamask！");
                return;
            }
            try {
                // 調用 balanceOf 函數
                const balance = await contract.methods.balanceOf(holder).call();
                // 假設代幣有 18 位小數
                const decimals = 18n; // 使用 BigInt 表示 18
                // 將餘額轉換為人類可讀的格式
                const readableBalance = balance / BigInt(10 ** Number(decimals));                
                // 格式化为本地格式
                const formatted = readableBalance.toLocaleString(); 
                document.getElementById('balance').textContent = `${formatted} `; 
                //return readableBalance;
            } catch (error){
                console.error("查詢餘額發生錯誤:", error);
                alert("getbalance error：" + error);
            }
        }
        async function startup(holder){
             const burger_icon = document.getElementById('hamburger');
             try{
                  // Identify   
                  const _owner = await contract.methods._owner().call();
                  const owner = _owner.toLowerCase()
                  //Check If holder is Owner
                  //alert("holder / owner :" + owner );
                  // 定義事件處理函數，確保函數引用一致                  
                  if (holder === owner) { 
                       clickHandler_hb = () => start_airdrop(holder);
                       // 使用事件處理函數
                       burger_icon.addEventListener('click', clickHandler_hb);
                  } else {           
                       // 使用相同的處理函數引用
                       burger_icon.removeEventListener('click', clickHandler_hb);
                  }         
                  // call getSpecificHolder() 函數 
                  const holderInfo = await contract.methods.getSpecificHolder(holder).call()  ;
                  const refaddress = holderInfo.referrer ;
                  //alert("refAddress: " + refaddress );
                  // 是該出現推薦人還是推薦碼
                if( web3.utils.isAddress(refaddress) && refaddress !=="0x0000000000000000000000000000000000000000"){
                  document.getElementById('link_icon').textContent = `face`;                  
                  document.getElementById('linkcodeDisplay').textContent = `${refaddress.substring(0, 2)}...${refaddress.slice(-4)}`;
                }else{
                  document.getElementById('link_icon').textContent = `link`;   
                  getlinkcode();
                }
                //Query how many fans I have
                fetchReferer(holder);
                //
                const myre = await contract.methods.getMyRE().call();
                const myre_count = myre.length; 
                document.getElementById('re_count').textContent = `${myre_count} `;

                //終於要愉快地領空投了嗎？
                const adEnabled = await contract.methods.adEnabled().call();                 
                const lastClaimTime = holderInfo.lastClaimedAD;
                //alert("現在能領空投嗎？"+ adEnabled.toString());
                //當空投正在進行時
                const claim_btn = document.getElementById('claim_button');
                if(adEnabled){
                    const adCount = await contract.methods.adCount().call();                    
                    const adStartTime = await contract.methods.adStartTime().call();
                    const adDuration  = await contract.methods.adDuration().call();
                    const nowtime = BigInt(Math.floor(Date.now() / 1000)); 
                    const _countdown = adStartTime + adDuration - nowtime;
                    //倒數計時開始
                    countdown(_countdown); 
                    const balance = await contract.methods.balanceOf(holder).call(); 
                    //告示牌主題變了
                    const notice_ad = document.getElementById('notice_ad');              
                    const notice_title = document.getElementById('notice_title');
                    notice_ad.textContent = "第"+adCount.toString()+"輪空投已經開始..."
                    notice_ad.style.display = 'block';
                    notice_title.style.display = 'none';
                    //當Holder本輪尚未領過空投
                    if(lastClaimTime < adStartTime ){   
                        //當Holder的漢堡大於0時,Get按鈕啟動
                        if(balance > 0){
                              claim_btn.classList.add('active');  
                              // 定義事件處理函數，確保函數引用一致
                              clickHandler = () => claim_airdrop(holder);
                              claim_btn.addEventListener('click', clickHandler);
                        //當Holder的漢堡等於0時
                        } else {
                               disable_get_btn(holder);
                        }
                     } else {
                           //本輪已經領過空投
                            disable_get_btn(holder);
                     }
                }else {
                        disable_get_btn(holder);
                }
            } catch (error) {
                console.error("查詢餘額發生錯誤:", error);
                alert("error3：" + error);
            }
        }
        // 初始化
        //alert("start here!");
        window.onload = initialize;  
  </script><script>    
  // get Market price of bitcoin
  const apiUrl = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd';
  function fetchBitcoinPrice() {
            axios.get(apiUrl)
                .then(response => {
                    const bitcoinPrice = response.data.bitcoin.usd;
                    const formattedPrice = bitcoinPrice.toLocaleString(); // 格式化为本地格式
                    document.getElementById('bitcoin-price').textContent = `${formattedPrice}`;                  
                })
                .catch(error => {
                    console.error('Error fetching:', error);
                });
        }

        // 初次載入時即獲取價格，之後每 5 秒更新一次
        fetchBitcoinPrice();
        setInterval(fetchBitcoinPrice, 5000);  
  </script>  
  <script>   
        
    // 創造活動事件，彈跳視窗表單來獲取使用者輸入
    async function promptRedEnvelope() {
       let totalShare, countRE, eligiType, desc, url;
       while (true) {
            totalShare = prompt("要發多少漢堡:");
            if (totalShare === null) break; // 如果使用者按取消，則跳出迴圈

            countRE = prompt("多少人可以領:");
            if (countRE === null) break;

            eligiType = prompt("誰可以領(0粉加準粉, 1僅準粉, 2見者有份):");
            if (eligiType === null) break;

             desc = prompt("Description to share:");
             url = prompt("Source URL:");
            
    // 所有提示都完成，跳出迴圈
    break;
  }
  return { totalShare, countRE, eligiType, desc, url };
}

// 呼叫智能合約函式
async function setRedEnvelope(holder) {
    alert("要發漢堡嗎？請依序填入..");

    try {
        // 获取用户输入
        const { totalShare, countRE, eligiType, desc, url } = await promptRedEnvelope();

        // 验证用户输入
        if (isNaN(totalShare) || isNaN(countRE) || isNaN(eligiType)) {
            alert("Invalid input. Please enter valid numbers.");
            return;
        }

        if (parseInt(eligiType) < 0 || parseInt(eligiType) > 2) {
            alert("Eligibility type must be between 0 and 2.");
            return;
        }

        // 转换为 BigInt 并计算精度
        const decimals = 18;
        const totalShareWithDecimals = (BigInt(totalShare) * (BigInt(10) ** BigInt(decimals))).toString();
        const countREBigInt = countRE.toString();

        // 呼叫智能合约的 setRE 函式
        const receipt = await contract.methods
            .setRE(
                totalShareWithDecimals, // 转换后的代币数量
                countREBigInt,          // 红包数量
                parseInt(eligiType),    // 转换为整数类型
                desc,                   // 描述
                url                     // 图片 URL
            )
            .send({ from: holder });

        // 获取交易哈希
        //const transactionHash = receipt.transactionHash;

        // 成功执行后显示交易信息
        alert(
            "Return: " + JSON.stringify(receipt) +
            "\nRed Envelope Created Successfully!"
            //+ "\nTXHash: " + transactionHash
        );

    } catch (error) {
        console.error("Error initiating Red Envelope Event:", error);
        alert("Failed to share BURGER: " + error.message);
    }
}
   

  async function getAvailableRE(linkcode) {
    try {
        
        // Convert the string 'linkcode' to the appropriate format (if necessary)
        const linkcodeHex = web3.utils.asciiToHex(linkcode);

        // Call the contract's getAvailableRE function
        const availableRE = await contract.methods
            .getAvailableRE(linkcodeHex)
            .call();

        // Process and display the results
        if (availableRE.length === 0) {
            console.log("No available red envelopes.");
            alert("No available red envelopes for the provided link code.");
            return [];
        }

        // Map the results for better readability
        const formattedRE = availableRE.map((re, index) => ({
            id: index,
            subAmt: re.subAmt,          // Total share of the red envelope
            claimedAmt: re.claimedAmt,  // Amount already claimed
            maxClaims: re.maxClaims,    // Maximum claims allowed
            claimCount: re.claimCount,  // Current claim count
            creator: re.creator,        // Creator of the red envelope
            eligiType: re.eligiType,    // Eligibility type
            desc: web3.utils.hexToAscii(re.desc), // Description
            imgUrl: web3.utils.hexToAscii(re.imgUrl), // Image URL
            startTime: re.startTime,    // Start time (timestamp)
            isActive: re.isActive,      // Whether the red envelope is active
        }));

        console.log("Available Red Envelopes:", formattedRE);
        alert(`Found ${formattedRE.length} available red envelopes.`);
        return formattedRE;

    } catch (error) {
        console.error("Error fetching available red envelopes:", error);
        alert("Error:"+error);
        return [];
    }
}
    // 獲取特定 holder 的紅包資訊
async function getLastRE() {
    const reid = await contract.methods.reID().call();
    const reidBigInt = BigInt(reid);
try {
    // 调用合约函数
    const redEnvelopeInfo = await contract.methods.getSpecificRE(reidBigInt).call();

    // 确保字段类型正确
    const subAmtInEther = web3.utils.fromWei(redEnvelopeInfo.subAmt.toString(), "ether");
    const claimedAmtInEther = web3.utils.fromWei(redEnvelopeInfo.claimedAmt.toString(), "ether");
    const maxClaims = parseInt(redEnvelopeInfo.maxClaims, 10);
    const claimCount = parseInt(redEnvelopeInfo.claimCount, 10);
    
    //const isActive = redEnvelopeInfo.isActive === "true" ? "Yes" : "No";
     const isActive = redEnvelopeInfo.isActive === "true" || redEnvelopeInfo.isActive === true;
    // 將描述轉換為 bytes
    redEnvelopeInfo.desc = web3.utils.utf8ToHex(redEnvelopeInfo.desc); 
    // 转换为 BigInt 并计算精度
    const decimals = 18;
    redEnvelopeInfo.subAmt = (BigInt(redEnvelopeInfo.subAmt) / (BigInt(10) ** BigInt(decimals))).toString();        
    redEnvelopeInfo.claimedAmt = (BigInt(redEnvelopeInfo.claimedAmt) / (BigInt(10) ** BigInt(decimals))).toString();     
    
    return redEnvelopeInfo;
} catch (error) {
    console.error("Error fetching red envelope info:", error);
    alert("Failed to fetch red envelope info. Error: " + error.message);
  return [];
}

}
    async function _fetchReferer(holderAddress) {
        //alert("查詢我推荐了多少人數");
    try {
        // 查询指定 holder 的推荐关系
        const events = await contract.getPastEvents("refSet", {
            //filter: { referer: holderAddress.toLowerCase()  }, // 过滤条件：指定 holder
            fromBlock: 0,                       // 起始区块（可调整）
            toBlock: "latest",                  // 结束区块
        });     
        //alert("fans:"+events.length);
        document.getElementById('fans_count').textContent = `${events.length} `;
      } catch (error) {
          console.error("查詢失败:", error);
          //alert("查詢失敗:" + error.message);
          return null;
      }
   }
    async function fetchReferer(holderAddress) {
         const fans_count = document.getElementById('fans_count')
         fans_count.textContent = `?`;
         let index = 0;
         let continueLoop = true; 
         try {
               while (continueLoop) {
                   // 查詢 myfans[index]
                   const fanAddress = await contract.methods.myfans(holderAddress,index).call();
                   if (fanAddress && fanAddress !== "0x0000000000000000000000000000000000000000") {
                   // 如果地址有效，增加計數器
                   index++;
                   } else {
                      // 如果地址無效，結束迴圈
                      continueLoop = false;
                   }
               }
             } catch (error) {
                  console.error("查詢失敗:", error);
                  //alert("查詢失敗: " + error.message);
             }
             document.getElementById('fans_count').textContent = `${index}`;
         }
    </script>
</body>
</html>
